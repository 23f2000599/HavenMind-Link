{% extends "base.html" %}

{% block content %}
<h1 class="text-3xl font-bold mb-8">ğŸ“ AI-Powered Journal</h1>

<!-- Analytics Dashboard -->
<div class="grid md:grid-cols-4 gap-6 mb-8">
    <div class="bg-white p-6 rounded-lg shadow">
        <h3 class="font-semibold text-lg mb-2">Mood Trend</h3>
        <div class="text-3xl font-bold text-{% if mood_trend > 0.6 %}green{% elif mood_trend > 0.4 %}yellow{% else %}red{% endif %}-600">
            {% if mood_trend > 0.6 %}ğŸ˜Š{% elif mood_trend > 0.4 %}ğŸ˜{% else %}ğŸ˜”{% endif %}
        </div>
        <p class="text-sm text-gray-600">
            {{ "%.0f"|format(mood_trend * 100) }}% positive
        </p>
        <div class="mt-2 bg-gray-200 rounded-full h-2">
            <div class="bg-{% if mood_trend > 0.6 %}green{% elif mood_trend > 0.4 %}yellow{% else %}red{% endif %}-500 h-2 rounded-full" style="width: {{ mood_trend * 100 }}%"></div>
        </div>
    </div>
    
    <div class="bg-white p-6 rounded-lg shadow">
        <h3 class="font-semibold text-lg mb-2">Writing Streak</h3>
        <div class="text-3xl font-bold text-purple-600">{{ writing_streak }}</div>
        <p class="text-sm text-gray-600">Days this month</p>
        {% if writing_streak >= 7 %}
            <p class="text-xs text-green-600 mt-1">âœ¨ Great consistency!</p>
        {% endif %}
    </div>
    
    <div class="bg-white p-6 rounded-lg shadow">
        <h3 class="font-semibold text-lg mb-2">Total Entries</h3>
        <div class="text-3xl font-bold text-blue-600">{{ entries|length }}</div>
        <p class="text-sm text-gray-600">All time</p>
    </div>
    
    <div class="bg-white p-6 rounded-lg shadow">
        <h3 class="font-semibold text-lg mb-2">Emotion Balance</h3>
        <div class="flex gap-1 mt-2">
            {% for emotion in emotion_stats %}
                <div class="flex-1 h-4 {% if emotion.emotion_tags == 'positive' %}bg-green-500{% elif emotion.emotion_tags == 'negative' %}bg-red-500{% else %}bg-gray-500{% endif %} rounded" title="{{ emotion.emotion_tags }}: {{ emotion.count }}"></div>
            {% endfor %}
        </div>
        <p class="text-xs text-gray-600 mt-1">Emotional distribution</p>
    </div>
</div>

<!-- AI Insights -->
{% if insights %}
<div class="bg-gradient-to-r from-indigo-50 to-purple-50 p-6 rounded-lg shadow mb-8">
    <h3 class="font-semibold text-lg mb-4 text-indigo-800">ğŸ¤– AI Insights & Recommendations</h3>
    <div class="space-y-3">
        {% for insight in insights %}
            <div class="bg-white p-4 rounded-lg border-l-4 border-indigo-500">
                <p class="text-sm text-gray-700">{{ insight }}</p>
            </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Writing Interface -->
<div class="grid md:grid-cols-2 gap-6 mb-8">
    <!-- Text Entry -->
    <div class="bg-white p-6 rounded-lg shadow">
        <h3 class="font-semibold mb-4">âœï¸ Write New Entry</h3>
        <form method="POST">
            <div class="mb-4">
                <button type="button" onclick="getPrompt()" class="text-sm text-indigo-600 hover:text-indigo-800 mb-2">
                    ğŸ¯ Get AI Writing Prompt
                </button>
                <div id="promptSuggestion" class="hidden mb-3 p-3 bg-yellow-50 border-l-4 border-yellow-400 text-sm text-yellow-800"></div>
            </div>
            <textarea name="content" id="journalContent" rows="6" class="w-full p-3 border rounded-lg" placeholder="How are you feeling today? What's on your mind? Share your thoughts freely..."></textarea>
            <div class="flex justify-between items-center mt-4">
                <div class="text-sm text-gray-500">
                    <span id="wordCount">0</span> words
                </div>
                <button type="submit" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700">
                    ğŸ’¾ Save Entry
                </button>
            </div>
        </form>
    </div>
    
    <!-- Voice Entry -->
    <div class="bg-white p-6 rounded-lg shadow">
        <h3 class="font-semibold mb-4">ğŸ¤ Voice Journal</h3>
        <div class="space-y-4">
            <textarea id="voiceJournalText" rows="10" class="w-full p-3 border rounded-lg resize-y min-h-[200px]" placeholder="Speak your thoughts or type here..."></textarea>
            <div class="flex gap-2">
                <button onclick="startVoiceJournal()" class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700">
                    ğŸ¤ Start Recording
                </button>
                <button onclick="saveVoiceEntry()" class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">
                    ğŸ’¾ Save Voice Entry
                </button>
            </div>
            <div id="voiceResponse" class="hidden p-3 bg-blue-50 rounded border-l-4 border-blue-400"></div>
        </div>
    </div>
</div>

<!-- Mindfulness Section -->
<div class="bg-white p-6 rounded-lg shadow mb-8">
    <h3 class="font-semibold text-lg mb-4">ğŸ§˜ Mindfulness & Reflection</h3>
    <div class="grid md:grid-cols-3 gap-4">
        <button onclick="startMindfulness('breathing')" class="p-4 bg-blue-50 hover:bg-blue-100 rounded-lg text-center transition-colors">
            <div class="text-2xl mb-2">ğŸŒ¬ï¸</div>
            <div class="font-medium text-blue-800">5-Min Breathing</div>
            <div class="text-sm text-blue-600">Calm your mind</div>
        </button>
        <button onclick="startMindfulness('gratitude')" class="p-4 bg-green-50 hover:bg-green-100 rounded-lg text-center transition-colors">
            <div class="text-2xl mb-2">ğŸ™</div>
            <div class="font-medium text-green-800">Gratitude Practice</div>
            <div class="text-sm text-green-600">Count your blessings</div>
        </button>
        <button onclick="startMindfulness('bodyscan')" class="p-4 bg-purple-50 hover:bg-purple-100 rounded-lg text-center transition-colors">
            <div class="text-2xl mb-2">ğŸ§˜</div>
            <div class="font-medium text-purple-800">Body Scan</div>
            <div class="text-sm text-purple-600">Release tension</div>
        </button>
    </div>
</div>

<!-- Journal Entries -->
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h3 class="font-semibold text-lg">ğŸ“š Your Journal Entries</h3>
        <div class="flex gap-2">
            <span class="px-3 py-1 bg-green-100 text-green-800 text-xs rounded-full">ğŸ˜Š Positive</span>
            <span class="px-3 py-1 bg-gray-100 text-gray-800 text-xs rounded-full">ğŸ˜ Neutral</span>
            <span class="px-3 py-1 bg-red-100 text-red-800 text-xs rounded-full">ğŸ˜” Negative</span>
            <span class="px-3 py-1 bg-red-600 text-white text-xs rounded-full">âš ï¸ Crisis</span>
        </div>
    </div>
    
    {% if entries %}
        {% for entry in entries %}
            <div class="bg-white p-6 rounded-lg shadow border-l-4 {% if entry.emotion_tags == 'crisis' %}border-red-600 bg-red-50{% elif entry.emotion_tags == 'positive' %}border-green-500{% elif entry.emotion_tags == 'negative' %}border-red-500{% else %}border-gray-500{% endif %} transition-all hover:shadow-md">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center gap-3">
                        <span class="text-sm text-gray-500">ğŸ“… {{ entry.created_at }}</span>
                        <span class="px-3 py-1 text-xs rounded-full {% if entry.emotion_tags == 'crisis' %}bg-red-600 text-white{% elif entry.emotion_tags == 'positive' %}bg-green-100 text-green-800{% elif entry.emotion_tags == 'negative' %}bg-red-100 text-red-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                            {% if entry.emotion_tags == 'crisis' %}âš ï¸{% elif entry.emotion_tags == 'positive' %}ğŸ˜Š{% elif entry.emotion_tags == 'negative' %}ğŸ˜”{% else %}ğŸ˜{% endif %} {{ entry.emotion_tags }}
                        </span>
                        <span class="text-xs text-gray-400">Score: {{ "%.1f"|format(entry.sentiment_score) }}</span>
                    </div>
                    <form method="POST" action="/journal/delete/{{ entry.id }}" class="inline">
                        <button type="submit" onclick="return confirm('Delete this entry?')" class="text-red-600 hover:text-red-800 text-xs">
                            ğŸ—‘ï¸ Delete
                        </button>
                    </form>
                </div>
                
                <div class="prose max-w-none mb-4">
                    <p class="text-gray-800 leading-relaxed">{{ entry.content }}</p>
                </div>
                
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border-l-4 border-blue-400">
                    <div class="flex items-start gap-2">
                        <div class="text-blue-600 mt-1">ğŸ¤–</div>
                        <div>
                            <p class="text-sm font-medium text-blue-800 mb-1">AI Companion Response:</p>
                            <p class="text-sm text-blue-700">
                                {{ generate_ai_response(entry.content, entry.emotion_tags, entry.sentiment_score) }}
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Mood Tracking -->
                <div class="mt-3 flex items-center gap-2">
                    <span class="text-xs text-gray-500">Mood Impact:</span>
                    <div class="flex gap-1">
                        {% for i in range(5) %}
                            <div class="w-2 h-2 rounded-full {% if (entry.sentiment_score * 5) > i %}bg-{% if entry.emotion_tags == 'crisis' %}red{% elif entry.emotion_tags == 'positive' %}green{% elif entry.emotion_tags == 'negative' %}red{% else %}gray{% endif %}-500{% else %}bg-gray-300{% endif %}"></div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <div class="bg-white p-12 rounded-lg shadow text-center">
            <div class="text-6xl mb-4">ğŸ“</div>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">Start Your Wellness Journey</h3>
            <p class="text-gray-500 mb-6">No journal entries yet. Begin writing to track your mental wellness and get AI-powered insights!</p>
            <div class="space-y-2 text-sm text-gray-400">
                <p>â€¢ Track your mood patterns over time</p>
                <p>â€¢ Get personalized AI responses and support</p>
                <p>â€¢ Build a consistent journaling habit</p>
                <p>â€¢ Access mindfulness exercises and prompts</p>
            </div>
        </div>
    {% endif %}
</div>

<script>
let recognition;
let isRecording = false;

// Word count functionality
document.getElementById('journalContent').addEventListener('input', function() {
    const wordCount = this.value.trim().split(/\s+/).filter(word => word.length > 0).length;
    document.getElementById('wordCount').textContent = wordCount;
});

// Voice journal functionality
function startVoiceJournal() {
    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-US';
        
        recognition.onstart = function() {
            isRecording = true;
            document.querySelector('button[onclick="startVoiceJournal()"]').textContent = 'ğŸ”´ Recording...';
            document.querySelector('button[onclick="startVoiceJournal()"]').classList.add('bg-red-600');
        };
        
        recognition.onresult = function(event) {
            let transcript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
                if (event.results[i].isFinal) {
                    transcript += event.results[i][0].transcript + ' ';
                }
            }
            if (transcript) {
                const textarea = document.getElementById('voiceJournalText');
                textarea.value += transcript;
                // Auto-scroll to bottom
                textarea.scrollTop = textarea.scrollHeight;
            }
        };
        
        recognition.onend = function() {
            isRecording = false;
            document.querySelector('button[onclick="startVoiceJournal()"]').textContent = 'ğŸ¤ Start Recording';
            document.querySelector('button[onclick="startVoiceJournal()"]').classList.remove('bg-red-600');
        };
        
        if (isRecording) {
            recognition.stop();
        } else {
            recognition.start();
        }
    } else {
        alert('Voice recognition not supported in this browser.');
    }
}

function saveVoiceEntry() {
    const voiceText = document.getElementById('voiceJournalText').value;
    if (!voiceText.trim()) {
        alert('Please record or type some content first.');
        return;
    }
    
    fetch('/journal/voice', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'voice_text=' + encodeURIComponent(voiceText)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('voiceResponse').innerHTML = `
                <p class="text-sm font-medium text-blue-800 mb-1">Entry saved! Emotion detected: ${data.emotion}</p>
                <p class="text-sm text-blue-700">${data.ai_response}</p>
            `;
            document.getElementById('voiceResponse').classList.remove('hidden');
            
            // Check if location sharing should be prompted
            if (data.prompt_location && data.emergency_contact) {
                promptLocationSharing(data.emergency_contact);
            }
            
            setTimeout(() => location.reload(), 3000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving entry. Please try again.');
    });
}

function getPrompt() {
    fetch('/journal/prompts')
    .then(response => response.json())
    .then(data => {
        const randomPrompt = data.prompts[Math.floor(Math.random() * data.prompts.length)];
        document.getElementById('promptSuggestion').textContent = randomPrompt;
        document.getElementById('promptSuggestion').classList.remove('hidden');
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function startMindfulness(type) {
    const exercises = {
        'breathing': 'Welcome to your breathing exercise. Find a comfortable position and close your eyes. Now breathe in slowly for four counts. Hold gently for four counts. Exhale slowly for six counts. Continue this rhythm. Focus only on your breath. You are safe and calm.',
        'gratitude': 'Welcome to your gratitude practice. Take a deep breath and relax. Think of three things you are grateful for today. Take your time with each one. Feel the appreciation in your heart.',
        'bodyscan': 'Welcome to your body scan meditation. Find a comfortable position and close your eyes. Starting with your toes, focus your attention there. Slowly move up through your body. Let any tension soften with your breath.'
    };
    
    const text = exercises[type];
    
    if ('speechSynthesis' in window) {
        speechSynthesis.cancel();
        
        function speakWithBestVoice() {
            const voices = speechSynthesis.getVoices();
            const utterance = new SpeechSynthesisUtterance(text);
            
            // Find best female voice
            const femaleVoice = voices.find(voice => 
                (voice.name.includes('Female') || 
                 voice.name.includes('Samantha') || 
                 voice.name.includes('Karen') || 
                 voice.name.includes('Zira') || 
                 voice.name.includes('Susan') ||
                 voice.gender === 'female') && 
                voice.lang.startsWith('en')
            ) || voices.find(voice => voice.lang.startsWith('en'));
            
            if (femaleVoice) {
                utterance.voice = femaleVoice;
            }
            
            utterance.rate = 0.8;
            utterance.pitch = 1.1;
            utterance.volume = 0.9;
            speechSynthesis.speak(utterance);
        }
        
        if (speechSynthesis.getVoices().length === 0) {
            speechSynthesis.addEventListener('voiceschanged', speakWithBestVoice, { once: true });
        } else {
            speakWithBestVoice();
        }
        
        alert(`ğŸ§˜ ${type.charAt(0).toUpperCase() + type.slice(1)} Exercise\n\nCalming female voice guidance will start.`);
    } else {
        alert(`ğŸ§˜ ${text}`);
    }
}

// Automatic location sharing functionality
function promptLocationSharing(emergencyContact) {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                shareLocationWithEmergencyContact(position.coords.latitude, position.coords.longitude, emergencyContact);
            },
            function(error) {
                console.error('Error getting location:', error);
                // Silently fail - don't alert user about location errors
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            }
        );
    }
}

function shareLocationWithEmergencyContact(latitude, longitude, emergencyContact) {
    fetch('/share-location', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            latitude: latitude,
            longitude: longitude
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show subtle notification instead of alert
            console.log(`Location automatically shared with ${emergencyContact} for safety purposes.`);
        }
    })
    .catch(error => {
        console.error('Error sharing location:', error);
    });
}

// Check for location sharing prompt on page load
document.addEventListener('DOMContentLoaded', function() {
    {% if prompt_location and emergency_contact %}
        promptLocationSharing('{{ emergency_contact }}');
    {% endif %}
});
</script>
{% endblock %}





