<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peer Supporter Dashboard - HavenMind</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        * { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-50">
    <!-- Navigation -->
    <nav class="bg-white/80 backdrop-blur-md border-b border-slate-200/50">
        <div class="max-w-7xl mx-auto px-6">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <img src="/static/logo.PNG" alt="HavenMind Logo" class="h-8 w-8">
                    <span class="font-bold text-xl text-slate-900">HavenMind Link</span>
                </div>
                <div class="flex items-center space-x-6">
                    <div class="flex items-center gap-2 bg-green-100 px-3 py-1 rounded-full">
                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                        <span class="text-sm text-green-700 font-medium">Online</span>
                    </div>
                    <a href="/logout" class="bg-slate-200 text-slate-700 px-4 py-2 rounded-lg hover:bg-slate-300 transition-colors">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-6 py-8">
        <!-- Stats Overview -->
        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-3xl shadow-lg border border-slate-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-semibold text-lg text-slate-900">Active Chats</h3>
                    <div class="w-12 h-12 bg-green-100 rounded-2xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                    </div>
                </div>
                <div class="text-3xl font-bold text-green-600 mb-2">2</div>
                <p class="text-sm text-slate-600">Students currently supported</p>
            </div>
            
            <div class="bg-white p-6 rounded-3xl shadow-lg border border-slate-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-semibold text-lg text-slate-900">Queue</h3>
                    <div class="w-12 h-12 bg-orange-100 rounded-2xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
                <div class="text-3xl font-bold text-orange-600 mb-2">3</div>
                <p class="text-sm text-slate-600">Students waiting for support</p>
            </div>
            
            <div class="bg-white p-6 rounded-3xl shadow-lg border border-slate-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-semibold text-lg text-slate-900">Rating</h3>
                    <div class="w-12 h-12 bg-purple-100 rounded-2xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                        </svg>
                    </div>
                </div>
                <div class="text-3xl font-bold text-purple-600 mb-2">4.9‚≠ê</div>
                <p class="text-sm text-slate-600">Average feedback score</p>
            </div>
            
            <div class="bg-white p-6 rounded-3xl shadow-lg border border-slate-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-semibold text-lg text-slate-900">This Week</h3>
                    <div class="w-12 h-12 bg-blue-100 rounded-2xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                </div>
                <div class="text-3xl font-bold text-blue-600 mb-2">23</div>
                <p class="text-sm text-slate-600">Students helped</p>
            </div>
        </div>

        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Student Queue -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-3xl shadow-lg border border-slate-200 overflow-hidden">
                    <div class="bg-slate-50 p-6 border-b border-slate-200">
                        <h3 class="text-xl font-bold text-slate-900">Support Queue</h3>
                        <p class="text-slate-600">Students waiting for help</p>
                    </div>
                    
                    <div class="p-6 space-y-4 max-h-96 overflow-y-auto">
                        {% if pending_requests %}
                            {% for request in pending_requests %}
                            <div class="p-4 {% if request.priority == 'urgent' %}bg-red-50 border-l-4 border-red-400{% elif request.priority == 'high' %}bg-yellow-50 border-l-4 border-yellow-400{% else %}bg-blue-50 border-l-4 border-blue-400{% endif %} rounded-2xl">
                                <div class="flex items-center justify-between mb-2">
                                    <p class="font-medium text-slate-900">{{ request.username }}</p>
                                    <span class="{% if request.priority == 'urgent' %}bg-red-100 text-red-700{% elif request.priority == 'high' %}bg-yellow-100 text-yellow-700{% else %}bg-blue-100 text-blue-700{% endif %} px-2 py-1 rounded-full text-xs font-medium">{{ request.priority.upper() }}</span>
                                </div>
                                <p class="text-sm text-slate-600 mb-3">"{{ request.message[:100] }}{% if request.message|length > 100 %}...{% endif %}"</p>
                                <div class="flex gap-2">
                                    <button onclick="acceptChat('{{ request.id }}', '{{ request.priority }}', '{{ request.message }}')" class="{% if request.priority == 'urgent' %}bg-red-600 hover:bg-red-700{% elif request.priority == 'high' %}bg-yellow-600 hover:bg-yellow-700{% else %}bg-blue-600 hover:bg-blue-700{% endif %} text-white px-3 py-1 rounded-lg text-sm font-medium transition-colors">Accept Chat</button>
                                    <button onclick="escalateToAI('{{ request.id }}')" class="bg-slate-200 text-slate-700 px-3 py-1 rounded-lg text-sm hover:bg-slate-300 transition-colors">AI Assist</button>
                                </div>
                            </div>
                            {% endfor %}
                        {% endif %}
                        
                        {% if active_chats %}
                            <div class="border-t border-slate-200 pt-4 mt-4">
                                <h4 class="font-medium text-slate-900 mb-3">Your Active Chats</h4>
                                {% for chat in active_chats %}
                                <div class="p-4 bg-green-50 border-l-4 border-green-400 rounded-2xl mb-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <p class="font-medium text-slate-900">{{ chat.username }}</p>
                                        <span class="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs font-medium">ACTIVE</span>
                                    </div>
                                    <p class="text-sm text-slate-600 mb-3">"{{ chat.message[:100] }}{% if chat.message|length > 100 %}...{% endif %}"</p>
                                    <button onclick="loadChatMessages('{{ chat.id }}'); currentStudent = '{{ chat.id }}'; document.getElementById('chatInput').style.display = 'block';" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-lg text-sm font-medium transition-colors">Continue Chat</button>
                                </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        {% if closed_chats %}
                            <div class="border-t border-slate-200 pt-4 mt-4">
                                <h4 class="font-medium text-slate-900 mb-3">Closed Cases</h4>
                                {% for chat in closed_chats %}
                                <div class="p-4 bg-gray-50 border-l-4 border-gray-400 rounded-2xl mb-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <p class="font-medium text-slate-900">{{ chat.username }}</p>
                                        <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded-full text-xs font-medium">
                                            {% if chat.status == 'professional' %}PROFESSIONAL CARE{% else %}ESCALATED{% endif %}
                                        </span>
                                    </div>
                                    <p class="text-sm text-slate-600 mb-3">"{{ chat.message[:100] }}{% if chat.message|length > 100 %}...{% endif %}"</p>
                                    <div class="text-xs text-gray-600">
                                        {% if chat.status == 'professional' %}
                                        ‚úÖ Case transferred to licensed mental health professional
                                        {% else %}
                                        ‚ö†Ô∏è Case escalated - awaiting professional intervention
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        {% if not pending_requests and not active_chats and not closed_chats %}
                            <div class="text-center text-slate-500 py-8">
                                <svg class="w-12 h-12 mx-auto mb-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                                </svg>
                                <p class="font-medium">No pending requests</p>
                                <p class="text-sm">Students will appear here when they need support</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Chat Interface -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-3xl shadow-lg border border-slate-200 overflow-hidden h-[600px] flex flex-col">
                    <div class="bg-slate-50 p-6 border-b border-slate-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-xl font-bold text-slate-900" id="chatTitle">Select a student to start chatting</h3>
                                <p class="text-slate-600" id="chatSubtitle">Choose from the queue or wait for new requests</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="getAISuggestion()" class="bg-indigo-100 text-indigo-700 px-3 py-2 rounded-lg text-sm font-medium hover:bg-indigo-200 transition-colors">
                                    ü§ñ AI Suggest
                                </button>
                                <button onclick="escalateToProf()" class="bg-red-100 text-red-700 px-3 py-2 rounded-lg text-sm font-medium hover:bg-red-200 transition-colors">
                                    ‚ö†Ô∏è Escalate
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="chatMessages" class="flex-1 overflow-y-auto p-6 space-y-4">
                        <div class="text-center text-slate-500 mt-20">
                            <svg class="w-16 h-16 mx-auto mb-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                            <p class="text-lg font-medium">No active chat</p>
                            <p class="text-sm">Accept a student from the queue to start supporting</p>
                        </div>
                    </div>
                    
                    <div class="p-6 border-t border-slate-200" id="chatInput" style="display: none;">
                        <div class="flex gap-3">
                            <input type="text" id="messageInput" placeholder="Type your supportive message..." class="flex-1 p-3 border border-slate-300 rounded-xl focus:border-indigo-500 focus:outline-none">
                            <button onclick="sendMessage()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl hover:bg-indigo-700 transition-colors font-medium">
                                Send
                            </button>
                        </div>
                        <div class="flex gap-2 mt-3">
                            <button onclick="quickResponse('validation')" class="px-3 py-1 bg-slate-100 text-slate-700 rounded-full text-sm hover:bg-slate-200 transition-colors">
                                That sounds really tough
                            </button>
                            <button onclick="quickResponse('support')" class="px-3 py-1 bg-slate-100 text-slate-700 rounded-full text-sm hover:bg-slate-200 transition-colors">
                                I'm here to listen
                            </button>
                            <button onclick="quickResponse('coping')" class="px-3 py-1 bg-slate-100 text-slate-700 rounded-full text-sm hover:bg-slate-200 transition-colors">
                                Let's work through this together
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Assistant Panel -->
        <div id="aiPanel" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
            <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full mx-4 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-slate-900">AI Suggestion</h3>
                    <button onclick="closeAIPanel()" class="text-slate-400 hover:text-slate-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="aiSuggestionContent" class="text-slate-700 mb-4">
                    <!-- AI suggestion will appear here -->
                </div>
                <div class="flex gap-3">
                    <button onclick="useAISuggestion()" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                        Use Suggestion
                    </button>
                    <button onclick="closeAIPanel()" class="flex-1 bg-slate-200 text-slate-700 py-2 rounded-lg hover:bg-slate-300 transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStudent = null;
        let currentAISuggestion = '';

        async function acceptChat(requestId, priority, message) {
            try {
                const response = await fetch('/accept-support-request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ request_id: requestId })
                });
                
                const result = await response.json();
                if (result.success) {
                    currentStudent = requestId;
                    document.getElementById('chatTitle').textContent = `Chat with Student (Request #${requestId})`;
                    document.getElementById('chatSubtitle').textContent = `Priority: ${priority.toUpperCase()} - Provide supportive guidance`;
                    document.getElementById('chatInput').style.display = 'block';
                    
                    // Load actual messages from database
                    loadChatMessages(requestId);
                    
                    // Refresh the page to update the request list
                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert('Failed to accept chat: ' + result.error);
                }
            } catch (error) {
                alert('Error accepting chat: ' + error.message);
            }
        }
        
        async function loadChatMessages(requestId) {
            try {
                const response = await fetch(`/get-peer-messages/${requestId}`);
                const messages = await response.json();
                
                const chatMessages = document.getElementById('chatMessages');
                
                // Check if professional has taken over
                if (messages.professional_takeover) {
                    chatMessages.innerHTML = `
                        <div class="flex items-center justify-center h-full text-slate-500">
                            <div class="text-center">
                                <div class="w-16 h-16 mx-auto mb-4 bg-blue-100 rounded-full flex items-center justify-center">
                                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                    </svg>
                                </div>
                                <p class="text-lg font-medium text-slate-900 mb-2">Professional Intervention Active</p>
                                <p class="text-sm text-slate-600">This case has been transferred to a licensed mental health professional.</p>
                                <p class="text-sm text-slate-600 mt-2">Thank you for your support. The student is now receiving specialized care.</p>
                                <p class="text-sm text-slate-600 mt-2 font-medium">For confidentiality, you can no longer view this conversation.</p>
                            </div>
                        </div>
                    `;
                    document.getElementById('chatInput').style.display = 'none';
                    return;
                }
                
                chatMessages.innerHTML = '';
                
                if (messages.length === 0) {
                    chatMessages.innerHTML = `
                        <div class="text-center text-slate-500 mt-20">
                            <p class="text-lg font-medium">Chat started!</p>
                            <p class="text-sm">Send a supportive message to begin</p>
                        </div>
                    `;
                    return;
                }
                
                messages.forEach(msg => {
                    const isOwn = msg.role === 'peer_supporter';
                    const decodedMessage = msg.message.replace(/&#39;/g, "'").replace(/&quot;/g, '"').replace(/&amp;/g, '&');
                    
                    // Skip system messages
                    if (decodedMessage.startsWith('[PEER_NOTE]') || 
                        decodedMessage.startsWith('[SYSTEM]') || 
                        decodedMessage.startsWith('[PROFESSIONAL NOTE]')) {
                        return;
                    }
                    
                    chatMessages.innerHTML += `
                        <div class="flex items-start gap-3 ${isOwn ? 'justify-end' : ''}">
                            <div class="bg-${isOwn ? 'indigo-600 text-white' : 'slate-100'} p-3 rounded-2xl max-w-md">
                                <p class="text-sm ${isOwn ? 'text-white' : 'text-slate-800'}">${decodedMessage}</p>
                                <p class="text-xs ${isOwn ? 'text-indigo-200' : 'text-slate-500'} mt-1">${msg.sender} ‚Ä¢ ${new Date(msg.created_at).toLocaleTimeString()}</p>
                            </div>
                        </div>
                    `;
                });
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        function getStudentMessage(studentId) {
            const messages = {
                '1247': "I'm having panic attacks and can't focus on anything. My heart races and I feel like I can't breathe. This is affecting my studies badly.",
                '1248': "I have 3 assignments due this week and 2 exams next week. I don't know how to manage everything. I'm barely sleeping.",
                '1249': "My parents are getting divorced and it's really affecting me. I can't concentrate on anything and feel lost."
            };
            return messages[studentId] || "Hi, I need someone to talk to...";
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message || !currentStudent) return;

            const chatMessages = document.getElementById('chatMessages');
            
            // Add peer message
            chatMessages.innerHTML += `
                <div class="flex items-start gap-3 justify-end">
                    <div class="bg-indigo-600 text-white p-3 rounded-2xl max-w-md">
                        <p class="text-sm">${message}</p>
                        <p class="text-xs text-indigo-200 mt-1">Just now</p>
                    </div>
                    <div class="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                </div>
            `;

            input.value = '';
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Send message to database
            try {
                await fetch('/peer-send-message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        request_id: currentStudent,
                        message: message 
                    })
                });
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        async function getAISuggestion() {
            if (!currentStudent) {
                alert('Please select a student first');
                return;
            }

            try {
                const response = await fetch('/peer-ai-assist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        studentId: currentStudent,
                        context: getStudentMessage(currentStudent)
                    })
                });
                
                const data = await response.json();
                currentAISuggestion = data.suggestion;
                
                document.getElementById('aiSuggestionContent').innerHTML = `
                    <div class="bg-indigo-50 p-4 rounded-lg mb-4">
                        <h4 class="font-medium text-indigo-900 mb-2">Suggested Response:</h4>
                        <p class="text-indigo-800">${data.suggestion}</p>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <h4 class="font-medium text-yellow-900 mb-2">Key Points:</h4>
                        <ul class="text-yellow-800 text-sm space-y-1">
                            ${data.keyPoints.map(point => `<li>‚Ä¢ ${point}</li>`).join('')}
                        </ul>
                    </div>
                `;
                
                document.getElementById('aiPanel').style.display = 'flex';
            } catch (error) {
                alert('AI assistance temporarily unavailable');
            }
        }

        function useAISuggestion() {
            document.getElementById('messageInput').value = currentAISuggestion;
            closeAIPanel();
        }

        function closeAIPanel() {
            document.getElementById('aiPanel').style.display = 'none';
        }

        function quickResponse(type) {
            const responses = {
                'validation': "That sounds really tough, and I can understand why you're feeling this way.",
                'support': "I'm here to listen and support you through this. You're not alone.",
                'coping': "Let's work through this together. What feels like the most manageable first step?"
            };
            document.getElementById('messageInput').value = responses[type];
        }

        function escalateToAI(studentId) {
            alert(`Connecting Student #${studentId} to AI support while you handle other urgent cases.`);
        }

        async function escalateToProf() {
            if (!currentStudent) return;
            
            const confirmed = confirm('Are you sure you want to escalate this to a professional counselor? This will mark it as a crisis situation.');
            if (!confirmed) return;
            
            try {
                const response = await fetch('/escalate-to-professional', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ request_id: currentStudent })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Crisis escalation successful. Professional counselor has been notified. Continue supporting the student until professional takes over.');
                    
                    // Add visual indicator for peer only
                    document.getElementById('chatTitle').innerHTML += ' <span class="bg-red-500 text-white px-2 py-1 rounded text-xs ml-2">ESCALATED</span>';
                    
                    // Change escalate button to show it's done
                    const escalateBtn = document.querySelector('button[onclick="escalateToProf()"]');
                    if (escalateBtn) {
                        escalateBtn.innerHTML = '‚úÖ Escalated';
                        escalateBtn.disabled = true;
                        escalateBtn.classList.add('opacity-50');
                    }
                } else {
                    alert('Failed to escalate: ' + result.error);
                }
            } catch (error) {
                alert('Error escalating to professional: ' + error.message);
            }
        }

        // Allow Enter key to send messages
        document.getElementById('messageInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Auto-refresh messages every 2 seconds when chat is active
        setInterval(() => {
            if (currentStudent) {
                loadChatMessages(currentStudent);
            }
        }, 2000);
        
        // Refresh when window gets focus
        window.addEventListener('focus', () => {
            if (currentStudent) {
                loadChatMessages(currentStudent);
            }
        });
    </script>
</body>
</html>